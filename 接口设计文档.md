# 接口设计文档

[TOC]



## 通用接口返回状态

所有接口请求成功都返回200 ,请求成功.

部分方法需要验证登录,等登录注册模块完成后再进行验证.

所有数据库操作失败都返回400,服务器忙,数据操作失败.

| 状态码<int> | 消息<string>           |
| ----------- | ---------------------- |
| 200         | 请求成功               |
| 300         | 未登录                 |
| 400         | 服务器忙,数据操作失败. |
| 501         | 没有评论写权限         |
| 502         | 没有评论删权限         |
| 503         | 没有新闻修改权限       |
| 504         | 没有新闻删除权限       |
| 505         | 请求参数错误           |

---------------------------------------------------------------------------------------------------------------------

吴斌

## 登录注册模块接口(3xxx)

### 注册(31xx)

请求:

方法 `POST`

参数:

| 参数名称 | 参数描述                                                |
| -------- | ------------------------------------------------------- |
| username | 用户名(4-20位字母数字下划线)                            |
| password | 密码(6-20位字母数字下划线)                              |
| v_code   | 验证码(到时候写了界面在加入验证码,接口开发的时候可忽略) |

响应:

默认的用户角色为普通用户

| 状态码<int> | 消息<string>         |
| ----------- | -------------------- |
| 3001        | 用户名已存在         |
| 3002        | 用户名长度不符合要求 |
| 3003        | 密码长度不符合要求   |
| 3004        | 注册验证码错误       |
| 3005        | 两次密码不一致       |

### 登录(32xx)

请求:

方法`POST`

参数:

| 参数名称 | 参数描述                                                |
| -------- | ------------------------------------------------------- |
| username | 用户名(4-20位字母数字下划线)                            |
| password | 密码(6-20位字母数字下划线)                              |
| v_code   | 验证码(到时候写了界面在加入验证码,接口开发的时候可忽略) |

响应:

成功200,后返回数据额外加一个Role角色

```json
{
    'code': 200,
    'msg': '请求成功',
    'role': 跳转网页<int:>0为用户,1为管理员
}
```

然后前端根据不同的Role_id跳转不同的页面

| 状态码<int> | 消息<string>   |
| ----------- | -------------- |
| 3201        | 用户名不存在   |
| 3202        | 密码错误       |
| 3203        | 登录验证码错误 |

### 注销(33xx)

直接删除request.session中的'user_id'

请求:

方法`GET`

参数:

无

响应:

两种状态 200,成功注销,400注销失败,服务器忙,稍后再试

### 昵称修改(34xx)

请求:

方法`POST`

参数:

| 参数名称 | 参数描述                     |
| -------- | ---------------------------- |
| nickname | 用户名(4-20位字母数字下划线) |

该方法通过request.session来获取`user_id`来确定用户,然后修改该用户的昵称,修改数据时记得try,错误就返回400,服务器忙.

响应:

| 状态码<int> | 消息<string>                                   |
| ----------- | ---------------------------------------------- |
| 3401        | 昵称修改错误(长度不符合要求最大长度为10个字符) |
| 3402        | 新旧昵称相同无法修改                           |

### 用户头像修改(35xx)

请求:

方法`POST`

参数:
| 参数名称   | 参数描述                                       |
| ---------- | ---------------------------------------------- |
| head_image | 二进制的图片数据(存储在七牛云还是本地稍后讨论) |

响应:

| 状态码<int> | 消息<string>         |
| ----------- | -------------------- |
| 3501        | 修改图片保存本地失败 |
| 3502        | 新旧昵称相同无法修改 |

---------------------------------------------------------------------------------------------------------------

杨凡

## 新闻模块接口(4xxx)

### 多条件查询

请求:

方法`GET`

参数:

| 参数名称 | 参数描述                                                    |
| -------- | ----------------------------------------------------------- |
| title    | 标题关键字,如果为空就全部获取,如果有值就%like%双向模糊匹配. |
| type     | 类型,如果为空就全部类型获取,如果有值就获取相关类型的新闻    |
| page     | 页数                                                        |
| rows     | 行数                                                        |

从数据库查询,page表示页数,rows表示每页行数,如果是第3页的内容显示10行,参数为page=3,rows=10,计算公式为(page-1)*rows,该值为offset参数,rows为limit参数.默认以点击量降序排序.

响应:

请求成功返回200,并且添加data属性,

```json
{
    'code': 200,
    'msg': '请求成功',
    'data': [
        ...这里为list数据
    ]
}
```

如果查询失败返回400, 服务器忙,稍后再试.

### 删除相关新闻(40xx)

请求:

方法`DELETE`

参数: 

| 参数名称 | 参数描述         |
| -------- | ---------------- |
| news_id  | 需要删除的新闻ID |

响应:

就两种

删除成功返回200,请求成功

删除失败返回4001,请求失败,删除的news_id 不存在.

### 修改相关新闻(41xx)

请求:

方法`POST`

参数:

| 参数名称     | 参数描述         |
| ------------ | ---------------- |
| news_id      | 新闻的主键ID     |
| title        | 新闻标题         |
| publish_time | 新闻发表时间     |
| content      | 新闻内容         |
| from_host    | 新闻来自哪个站点 |

响应:

修改成功200,请求成功

修改失败4101,修改失败,主键不存在.

### 获取新闻点赞(42xx)

请求:

方法`GET`

参数:

| 参数名称 | 参数描述     |
| -------- | ------------ |
| news_id  | 新闻的主键ID |

访问新闻点赞表查询`news_id`新闻,然后统计次数

响应:

请求成功返回200

```json
{
    'code': 200,
    'msg': 请求成功,
    'total': <int: total> 整型点赞的次数
}
```

请求失败4201,请求的news_id不存在.

### 新闻点赞(43xx)

请求:

方法`GET`

参数:

| 参数名称 | 参数描述     |
| -------- | ------------ |
| news_id  | 新闻的主键ID |

请求获取news_id和request.session('user_id')中的user_id添加到新闻点赞表中,如果已经存在相同的news_id和user_id就说明已经点过赞,无法再次点赞.

响应:

请求成功,返回200

点赞失败,已经点过赞无法再次点赞返回4301,

数据添加,查询失败请返回400.



-------------------------------------------------------------------------------------------------------------------------------

黄成

## 评论操作接口(5xxx)

### 添加评论(51xx)

请求:

方法`POST`

参数:

| 参数名称 | 参数描述     |
| -------- | ------------ |
| news_id  | 新闻的主键ID |
| review   | 评论内容     |

通过request.session['user_id']来获取用户ID,然后添加数据到Review表中

响应:

添加成功,返回200,

添加失败,权限不足,或未登录,数据库访问失败.

### 评论的查询(52xx)

请求:

方法`GET`

参数:

| 参数名称 | 参数描述                                    |
| -------- | ------------------------------------------- |
| news_id  | 新闻的主键ID(必须的)                        |
| page     | 第几页评论                                  |
| rows     | 每页多少行                                  |
| user_id  | 哪个用户的评论(可选,为空着该新闻的所有评论) |

page为查询出来的评论第几页,rows为每页多少行, 如page=2,rows=10,则为每页10行的第二页,算法为offset((page-1)*rows).limit(rows)

### 评论的赞与踩(53xx)

请求:

方法`GET`

参数:

| 参数名称  | 参数描述     |
| --------- | ------------ |
| review_id | 评论的ID     |
| is_liked  | 0为踩, 1为赞 |

user_id可以通过request.session['user_id']获取,然后添加到review_liked表中.

响应:

请求成功200,

请求失败,未登录,review_id为空返回5301,数据库访问失败,返回400

### 评论的删除(54xx)

请求:

方法`DELETE`

参数:

| 参数名称  | 参数描述 |
| --------- | -------- |
| review_id | 评论的ID |

响应:

请求成功返回200,

请求失败,见通用code,权限,登录,数据库问题





任麒霖

## 后台首页接口(6xxx)

### 网站访问量统计(61xx)

请求:

方法`GET`

参数:

无

响应:

从redis中获取近日访问量,然后返回数据

```json
{
    'code': 200,
    'msg': '请求成功!',
    'data': [
        {'date':'日期', 'total':'次数'},
        ...(近五日)
    ]
}
```

请求失败,数据库请求失败返回400,通用状态码



### 活跃用户量统计(62xx)

请求:

方法`GET`

参数:

无

响应:

通过datetime模块获取当前天日期,然后在数据库查找当前日期登录过的用户数量

```json
{
    'code': 200,
    'msg': '请求成功!',
    'total': <int: 次数>
}
```

请求失败返回,数据库链接失败,未登录等通用状态码

### 日增新闻数量获取

请求:

方法`GET`

参数:

无

响应:

通过datetime获取当前近五天日期,然后统计这几天的新闻条数,然后返回数据

```json
{
    'code':200,
    'msg': '请求成功!',
    'data': [
        {'date':'日期', 'total':'次数'},
        ...(近五天)
    ]
}
```

请求失败,未登录,数据库请求失败等见通用状态码

### 新闻类型占比数据接口

请求:

方法`GET`

参数:

无

响应:

通过News表对type_id进行分组,然后在统计次数,返回响应数据

```json
{
    'code': 200,
    'msg': '请求成功!',
    'data': [
        {'type_name': '', 'total': 123},
        ....
    ]
}
```



------------------------------------------------------------------------------------------------------------------

鞠东

## 用户权限修改(7xxx)

### 权限增删改查(71xx)

Permission表

**添加**

请求:

方法`POST`

参数:

| 参数名称 | 参数描述 |
| -------- | -------- |
| per_name | 权限名称 |

响应:

请求成功200,

其他参考通用状态码

**删除**

请求:

方法`DELETE`

参数:

| 参数名称 | 参数描述 |
| -------- | -------- |
| per_id   | 权限ID   |

响应:

请求成功200,

其他参考通用状态码

**修改**

请求:

方法`POST`

参数:

| 参数名称 | 参数描述 |
| -------- | -------- |
| per_id   | 权限ID   |
| per_name | 权限名称 |

响应:

请求成功200,

其他参考通用状态码.



**查询**

请求:

方法`GET`

参数:

无

响应:

请求成功200, 返回所有的权限

```json
{
    'code':200,
    'msg': '请求成功!',
    'data': [
        {'id':'', 'name': ''},
        ...
    ]
}
```

### 角色权限的增删改查(72xx)

**查询**

请求:

方法`GET`

参数:

| 参数名称  | 参数描述 |
| --------- | -------- |
| role_name | 角色名称 |

响应:

通过角色的名称查询所拥有的权限.

```json
{
    'code':200,
    'msg': '请求成功!',
    'data': [
        {'per_id':'权限ID', 'per_name': '权限名称'},
        ...
    ]
}
```

**增**

请求:

方法`POST`

参数:

| 参数名称 | 参数描述 |
| -------- | -------- |
| role_id  | 角色ID   |
| per_id   | 权限ID   |

响应:

通过角色ID和权限ID来添加,添加时,查看是否已经存在,如果存在就返回7201,权限已拥有

```json
{
    'code': 7201,
    'msg': 权限已经拥有
}
```

**删**

请求:

方法`DELETE`

参数:

| 参数名称 | 参数描述 |
| -------- | -------- |
| role_id  | 角色ID   |
| per_id   | 权限ID   |

响应:

通过角色ID和权限ID来删除如果成功就返回200,如果不存在,删除失败就返回7202

```json
{
    'code': 7202,
    'msg': '删除权限失败!'
}
```

更多失败请求请参考通用状态码.



### 用户角色修改(73xx)

请求:

方法`POST`

参数:

| 参数名称 | 参数描述 |
| -------- | -------- |
| user_id  | 用户ID   |
| role_id  | 角色ID   |

响应:

找到对应的用户,修改为对应的新的角色ID

请求成功就返回200,

失败参考通用状态码















